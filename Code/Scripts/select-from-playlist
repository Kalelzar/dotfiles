#!/bin/bash

export MPD_PORT="$(cat "$XDG_CONFIG_HOME/kaltemplate/capabilities/mpdPort.cpb")"

res="$(xwininfo -root | grep Height | sed -E 's/[[:space:]]+//g' | cut -d: -f2)"
lines=$(((7*res - 72)/156))

current=$(mpc -f "%position%ğŸ’Œ%title%ğŸ’Œ%artist%ğŸ’Œ%album%" current)
queued=$(mpc -f "%position%ğŸ’Œ%title%ğŸ’Œ%artist%ğŸ’Œ%album%" queued)

playlist="$(mpc -f "##ğŸ’Œ%position%ğŸ’Œ%title%ğŸ’Œ%artist%ğŸ’Œ%album%" playlist \
                | sed -E "s/#ğŸ’Œ($current)/>ğŸ’Œ\1/g;s/#ğŸ’Œ($queued)/*ğŸ’Œ\1/g;s/#ğŸ’Œ/ ğŸ’Œ/g" \
                | sed 's/,/^/g;s/ğŸ’Œ/,/g')"

curind="$(($(mpc -f "%position%" current) - 1))"
queind="$(($(mpc -f "%position%" queued) - 1))"

playlistid="$(echo -e "$playlist" \
                   | csv-format \
                   | tr '^' ',' \
                   | sed -E 's/[â•šâ•â•©â•â• â•¬â•£â•”â•¦â•—]//g;/^$/d;s/â•‘/â€‹/g'\
                   | rofi -dmenu -l $lines \
                                 -i \
                                 -r \
                                 -p "Song"\
                                 -mesg "Pick song from queue."\
                                 -a "$curind" \
                                 -u "$queind" \
                                 -selected-row "$curind"\
                   | sed 's/â€‹/|/g'\
                   | cut -d'|' -f3)"

[[ "$playlistid" =~ [[:digit:]]+ ]] || exit 1


mpc play $playlistid
